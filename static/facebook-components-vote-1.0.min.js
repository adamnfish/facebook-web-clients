ensurePackage("guardian.facebook"),function(){function e(e,t,n){this.model=e,this.view=t,this.authorizer=n}e.prototype.model=null,e.prototype.view=null,e.prototype.authorizer=null,e.prototype.initialise=function(e){this.baseURI=e,this.authorizer.on("connected",this.checkExistingVote,this),this.authorizer.on("notAuthorized",this.handleNotAuthorized,this),this.view.on("voted",this.submitVote,this),jQuery.ajax({url:this.baseURI+"/poll",dataType:"jsonp",data:{article:this.getArticleId()}}).then(this.handleLoadedData.bind(this))},e.prototype.handleLoadedData=function(e){this.model.setAllData(e.questions[0])},e.prototype.getArticleId=function(){return jQuery("meta[property='og:url']").attr("content")},e.prototype.checkExistingVote=function(){console.log("Controller: Checking for existing votes  on user "+this.authorizer.userId),jQuery.ajax({url:this.baseURI+"/user",type:"GET",dataType:"jsonp",data:{article:this.getArticleId(),user:this.authorizer.userId}}).then(this.handleUserExistingVote.bind(this))},e.prototype.handleNotAuthorized=function(){console.log("Controller: User is not authorized to use app, but showing buttons"),this.model.setAllowedToVote(!0)},e.prototype.handleUserExistingVote=function(e){e.choice?(console.log("Controller: User has already voted for "+e.choice),this.model.registerVote(e.choice,!1)):(console.log("Controller: User has not voted yet"),this.model.setAllowedToVote(!0))},e.prototype.submitVote=function(e){this.authorizer.authUser().then(function(){jQuery.ajax({url:this.baseURI+"/vote",dataType:"jsonp",data:{article:this.getArticleId(),access_token:this.authorizer.accessToken,user:this.authorizer.userId,action:e}}).then(this.handlePostResponse.bind(this,e))}.bind(this))},e.prototype.handlePostResponse=function(e,t){t.error?console.error("Controller: Sorry - could not register your vote: "+t.error.message):(console.log("Controller: Posted response to Facebook OK. Voted for "+e),this.model.registerVote(e,!0))},e.prototype.destroy=function(){this.model.un(null,this)},e.APP_NAMESPACE="theguardian-spike",guardian.facebook.VoteController=e}(),function(){function e(e,t){this.jContainer=jQuery(e),this.authorizer=t,this.authorizer.getLoginStatus().then(this.showLoggedIn.bind(this)),this.authorizer.on("notLoggedIn",this.showLoginButton,this),this.authorizer.on("notAuthorized",this.showAuthorizeButton,this),this.authorizer.on("gotUserDetails",this.showLoggedIn,this),this.jContainer.delegate(".login","click.vote-component",this.handleLoginClick.bind(this))}e.prototype.showLoggedIn=function(e){e&&e.name?this.jContainer.find(".user-details").html("<span class='login'>Logged in as "+e.name+"</span>"):this.jContainer.find(".user-details").html("<span class='login'>Logged in</span>")},e.prototype.showLoginButton=function(){if(this.jContainer.find("a.login").length){this.handleLoginClick();return}this.jContainer.find(".user-details").html("<a class='login' href='http://www.facebook.com/'>Log in to Facebook</a>")},e.prototype.showAuthorizeButton=function(){console.log("Showing authorize button");if(this.jContainer.find(".login").length){this.handleLoginClick();return}this.jContainer.find(".user-details").html("<a class='login' href='http://www.facebook.com/'>Use the Guardian Facebook App</a>")},e.prototype.handleLoginClick=function(){return this.jContainer.find(".user-details").empty(),this.authorizer.authUser(),!1},guardian.facebook.LoginButtonView=e}(),function(){function e(){this.choice=undefined,this.allowedToVote=!0,this.dataDeferred=jQuery.Deferred()}e.prototype=Object.create(Subscribable.prototype),e.prototype.questionId=null,e.prototype.options=null,e.prototype.choice=null,e.prototype.allowedToVote=null,e.prototype.setAllData=function(e){this.questionId=e.id,this.answers=e.answers,this.fire("dataChanged"),this.dataDeferred.resolve()},e.prototype.whenDataIsSet=function(){return this.dataDeferred.promise()},e.prototype.setAllowedToVote=function(e){this.allowedToVote=e,this.fire("dataChanged")},e.prototype.getAgree=function(){return this.answers&&this.answers[0].count},e.prototype.getDisagree=function(){return this.answers&&this.answers[1].count},e.prototype.getTotal=function(){return this.getAgree()+this.getDisagree()},e.prototype.getAnswerById=function(e){return this.answers.filter(function(t){return t.id==e})[0]},e.prototype.registerVote=function(e,t){this.whenDataIsSet().then(function(){var n=this.getAnswerById(e);n?(t===undefined||t===!0?(console.log("Model: Registering new vote: "+e),n.count++):console.log("Model: Noticing existing vote: "+e),this.choice=e,this.fire("dataChanged")):console.log("Unrecognised vote: "+e)}.bind(this))},e.prototype.getSummaryText=function(){return this.choice?"Your response was: "+this.getAnswerById(this.choice).label:"Your vote will be counted and shared on Facebook"},e.prototype.canVote=function(){return!this.choice&&this.allowedToVote},e.prototype.getAgreePercent=function(){var t=this.getTotal();return t?this.getAgree()/t*100:e.EVEN},e.prototype.destroy=function(){this.un()},e.EVEN=50,guardian.facebook.VoteModel=e}(),function(){function e(e,t,n){this.jContainer=jQuery(e).removeClass("initially-off"),this.model=t,this.initialise(n)}e.prototype=Object.create(Subscribable.prototype),e.prototype.jContainer=null,e.prototype.donut=null,e.prototype.model=null,e.prototype.initialise=function(t){this.jContainer.html(e.HTML),this.model.on("dataChanged",this.render,this),this.donut=new t(this.jContainer.find(".donut-container")),this.jContainer.delegate(".btn","click.vote-component",this.handleButtonClick.bind(this))},e.prototype.setVotingInProgress=function(){this.jContainer.find(".social-summary .text").html("Sending your vote to Facebook...")},e.prototype.render=function(){this.donut.render(this.model.getAgreePercent());var e=this.model.answers;this.jContainer.find(".choice").each(function(t,n){var r=e[t];jQuery(n).attr("data-action",r.id),jQuery(n).find(".count").html(r.count),jQuery(n).find(".label").html(r.label)}),this.jContainer.find(".choice").toggleClass("btn",this.model.canVote()),this.jContainer.find(".social-summary .text").html(this.model.getSummaryText())},e.prototype.handleButtonClick=function(e){var t=jQuery(e.currentTarget),n=t.data("action");this.jContainer.find(".btn").removeClass("btn"),this.fire("voted",n)},e.prototype.destroy=function(){this.model.un(null,this),this.jContainer.undelegate(".vote-component")},e.HTML='<div class="vote-component"><div class="vote-area"><span class="choice agree" data-action="agree"><span class="label"></span><span class="count"></span></span><div class="donut-container"></div><span class="choice disagree" data-action="disagree"><span class="count"></span><span class="label"></span></span></div><div class="social-summary"><span class="text"></span><div class="facebook-auth-status"><div class="user-details"></div></div></div></div>',guardian.facebook.VoteComponent=e}();