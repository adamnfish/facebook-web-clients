ensurePackage("guardian.facebook"),function(e){"use strict";function t(){}function i(e,t){if(r)return t.indexOf(e);var n=t.length;while(n--)if(t[n]===e)return n;return-1}var n=t.prototype,r=Array.prototype.indexOf?!0:!1;n.getListeners=function(e){var t=this._events||(this._events={});return t[e]||(t[e]=[])},n.addListener=function(e,t){var n=this.getListeners(e);return i(t,n)===-1&&n.push(t),this},n.on=n.addListener,n.removeListener=function(e,t){var n=this.getListeners(e),r=i(t,n);return r!==-1&&(n.splice(r,1),n.length===0&&(this._events[e]=null)),this},n.off=n.removeListener,n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if(typeof t=="object")for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&(typeof i=="function"?s.call(this,r,i):o.call(this,r,i));else{r=n.length;while(r--)s.call(this,t,n[r])}return this},n.removeEvent=function(e){return e?this._events[e]=null:this._events=null,this},n.emitEvent=function(e,t){var n=this.getListeners(e),r=n.length,i;while(r--)i=t?n[r].apply(null,t):n[r](),i===!0&&this.removeListener(e,n[r]);return this},n.trigger=n.emitEvent,e.EventEmitter=t}(this),function(){function e(e){return e}guardian.facebook.BigNumberFormatter=e}(),function(){function e(e,t,n){this.model=e,this.view=t,this.authorizer=n}e.prototype.model=null,e.prototype.view=null,e.prototype.authorizer=null,e.prototype.initialise=function(e){this.baseURI=e,this.checkExistingVoteCallback=this.checkExistingVote.bind(this),this.authorizer.on(guardian.facebook.Authorizer.AUTHORIZED,this.checkExistingVoteCallback),this.handleNotAuthorizedCallback=this.handleNotAuthorized.bind(this),this.authorizer.on(guardian.facebook.Authorizer.NOT_AUTHORIZED,this.handleNotAuthorizedCallback),this.view.on("voted",this.submitVote.bind(this)),jQuery.ajax({url:this.baseURI+"/poll",dataType:"jsonp",data:{article:this.getArticleId()}}).then(this.handleLoadedData.bind(this))},e.prototype.handleLoadedData=function(e){this.model.setAllData(e.questions[0])},e.prototype.getArticleId=function(){return jQuery("meta[property='og:url']").attr("content")},e.prototype.checkExistingVote=function(){console.log("Controller: Checking for existing votes  on user "+this.authorizer.userId),jQuery.ajax({url:this.baseURI+"/user",type:"GET",dataType:"jsonp",data:{article:this.getArticleId(),user:this.authorizer.userId}}).then(this.handleUserExistingVote.bind(this))},e.prototype.handleNotAuthorized=function(){console.log("Controller: User is not authorized to use app, but showing buttons"),this.model.setAllowedToVote(!0)},e.prototype.handleUserExistingVote=function(e){e.choice?(console.log("Controller: User has already voted for "+e.choice),this.model.registerVote(e.choice,!1)):(console.log("Controller: User has not voted yet"),this.model.setAllowedToVote(!0))},e.prototype.submitVote=function(e){this.authorizer.authUser().then(function(){jQuery.ajax({url:this.baseURI+"/vote",dataType:"jsonp",data:{article:this.getArticleId(),access_token:this.authorizer.accessToken,user:this.authorizer.userId,action:e}}).then(this.handlePostResponse.bind(this,e))}.bind(this))},e.prototype.handlePostResponse=function(e,t){t.error?console.error("Controller: Sorry - could not register your vote: "+t.error.message):(console.log("Controller: Posted response to Facebook OK. Voted for "+e),this.model.registerVote(e,!0))},e.prototype.destroy=function(){this.model.removeEvent(guardian.facebook.Authorizer.AUTHORIZED,this.checkExistingVoteCallback),this.model.removeEvent(guardian.facebook.Authorizer.NOT_AUTHORIZED,this.handleNotAuthorizedCallback)},e.APP_NAMESPACE="theguardian-spike",guardian.facebook.VoteController=e}(),function(){function e(e,t){this.jContainer=jQuery(e),this.authorizer=t,this.jContainer.find("a").html("Your vote will be counted and shared on Facebook"),this.authorizer.getLoginStatus().then(this.showLoggedIn.bind(this)),this.authorizer.on(guardian.facebook.Authorizer.GOT_USER_DETAILS,this.showLoggedIn.bind(this)),this.authorizer.on(guardian.facebook.Authorizer.NOT_LOGGED_IN,this.showAuthorizeButton.bind(this)),this.authorizer.on(guardian.facebook.Authorizer.NOT_AUTHORIZED,this.showAuthorizeButton.bind(this)),this.jContainer.delegate(".login","click.loginbutton",this.handleLoginClick.bind(this))}e.prototype.showLoggedIn=function(e){console.log(e),e&&e.first_name?this.jContainer.find("a").html(e.first_name+", your vote will be counted and shared on Facebook"):this.jContainer.find("a").html("Your vote will be counted and shared on Facebook")},e.prototype.showAuthorizeButton=function(){if(this.shouldLogInNow){this.handleLoginClick();return}this.shouldLogInNow=!0},e.prototype.handleLoginClick=function(){return this.authorizer.authUser(),!1},guardian.facebook.LoginButtonView=e}(),function(){function e(){this.choice=undefined,this.allowedToVote=!0,this.dataDeferred=jQuery.Deferred()}e.prototype=Object.create(EventEmitter.prototype),e.prototype.questionId=null,e.prototype.options=null,e.prototype.choice=null,e.prototype.allowedToVote=null,e.prototype.setAllData=function(t){this.answers=t.answers,this.trigger(e.DATA_CHANGED),this.dataDeferred.resolve()},e.prototype.whenDataIsSet=function(){return this.dataDeferred.promise()},e.prototype.setAllowedToVote=function(t){this.allowedToVote=t,this.trigger(e.DATA_CHANGED)},e.prototype.getAgree=function(){return this.answers&&this.answers[0].count},e.prototype.getDisagree=function(){return this.answers&&this.answers[1].count},e.prototype.getTotal=function(){return this.getAgree()+this.getDisagree()},e.prototype.getAnswerById=function(e){return this.answers.filter(function(t){return t.id==e})[0]},e.prototype.registerVote=function(t,n){this.whenDataIsSet().then(function(){var r=this.getAnswerById(t);r?(n===undefined||n===!0?(console.log("Model: Registering new vote: "+t),r.count++):console.log("Model: Noticing existing vote: "+t),this.choice=t,this.trigger(e.DATA_CHANGED)):console.log("Unrecognised vote: "+t)}.bind(this))},e.prototype.getSummaryText=function(){return this.choice?"Your response was: "+this.getAnswerById(this.choice).label:undefined},e.prototype.canVote=function(){return!this.choice&&this.allowedToVote},e.prototype.getAgreePercent=function(){var t=this.getTotal();return t?this.getAgree()/t*100:e.EVEN},e.prototype.destroy=function(){this.removeEvent()},e.DATA_CHANGED="dataChanged",e.EVEN=50,guardian.facebook.VoteModel=e}(),function(){function e(e,t,n,r){this.jContainer=jQuery(e).removeClass("initially-off"),this.model=t,this.numberFormatter=r,this.initialise(n)}e.prototype=Object.create(EventEmitter.prototype),e.prototype.jContainer=null,e.prototype.donut=null,e.prototype.numberFormatter=null,e.prototype.model=null,e.prototype.initialise=function(t){this.jContainer.html(e.HTML),this.renderCallback=this.render.bind(this),this.model.on("dataChanged",this.renderCallback),this.donut=new t(this.jContainer.find(".donut-container")),this.jContainer.delegate(".btn","click.vote-component",this.handleButtonClick.bind(this))},e.prototype.updateButton=function(e,t,n){var r=e[t],i=jQuery(n);i.attr("data-action",r.id),i.find(".count").html(this.numberFormatter(r.count)),i.find(".label").html(r.label)},e.prototype.render=function(){this.donut.render(this.model.getAgreePercent()),this.jContainer.find(".choice").each(this.updateButton.bind(this,this.model.answers)).toggleClass("btn",this.model.canVote()),this.model.getSummaryText()&&this.jContainer.find(".social-summary a").html(this.model.getSummaryText()),this.animated||(this.animated=!0,jQuery(".vote-component").animate({height:"180px"}))},e.prototype.handleButtonClick=function(e){var t=jQuery(e.currentTarget),n=t.data("action");this.jContainer.find(".btn").removeClass("btn"),this.trigger("voted",[n])},e.prototype.destroy=function(){this.model.removeEvent("dataChanged",this.renderCallback),this.jContainer.undelegate(".vote-component")},e.HTML='<div class="vote-component"><div class="social-summary"><div class="avatar"></div><a></a></div><div class="vote-area"><span class="choice agree" data-action="agree"><span class="label"></span><span class="count"></span></span><div class="donut-container"></div><span class="choice disagree" data-action="disagree"><span class="count"></span><span class="label"></span></span></div></div>',guardian.facebook.VoteComponent=e}();