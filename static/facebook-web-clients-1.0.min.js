ensurePackage("guardian.ui"),ensurePackage("guardian.facebook"),function(e){function t(t){this.jContainer=e(t),this.initialise()}t.prototype.jContainer=null,t.prototype.ctx=null,t.prototype.getCanvas=function(){var e=document.createElement("canvas");return e.width=this.jContainer.width()||160,e.height=this.jContainer.height()||160,this.jContainer[0].appendChild(e),window.G_vmlCanvasManager?window.G_vmlCanvasManager.initElement(e):e},t.prototype.initialise=function(){var e=this.getCanvas();this.ctx=e.getContext("2d")},t.prototype.render=function(e){var n=this.ctx,r=this.jContainer.width(),i=this.jContainer.height(),s=r/2,o=i/2,u=(Math.min(r,i)-24)/2,a=Math.PI*2*((100-e)/100),f=a/2,l=u*2*Math.cos(f),c=u*2*Math.sin(f);n.clearRect(0,0,r,i),this.setStroke(e==100?t.POSITIVE:t.NEGATIVE),n.beginPath(),n.arc(s,o,u,0,Math.PI*2,!0),n.stroke(),e>0&&(this.setStroke(t.POSITIVE),n.beginPath(),n.arc(s,o,u,-f,+f,!0),n.stroke()),this.setStroke(t.NOTCH),n.beginPath(),n.moveTo(s,o),n.lineTo(s+l,o+c),n.stroke(),n.beginPath(),n.moveTo(s,o),n.lineTo(s+l,o-c),n.stroke()},t.prototype.setStroke=function(e){this.ctx.lineWidth=e["stroke-width"],this.ctx.strokeStyle=e.stroke},t.POSITIVE={stroke:"#3A7D00","stroke-width":18},t.NEGATIVE={stroke:"#0D3D00","stroke-width":18},t.NOTCH={stroke:"#fff","stroke-width":1},guardian.ui.CanvasDonut=t}(window.jQuery),function(){function e(e,t,n){this.model=e,this.view=t,this.authorizer=n}e.prototype.model=null,e.prototype.view=null,e.prototype.authorizer=null,e.prototype.initialise=function(e){this.baseURI=e,this.authorizer.on("connected",this.checkExistingVote,this),this.authorizer.on("notAuthorized",this.handleNotAuthorized,this),this.view.on("voted",this.submitVote,this),jQuery.ajax({url:this.baseURI+"/poll",dataType:"jsonp",data:{article:this.getArticleId()}}).then(this.handleLoadedData.bind(this))},e.prototype.handleLoadedData=function(e){this.model.setAllData(e.questions[0])},e.prototype.getArticleId=function(){return jQuery("meta[property='og:url']").attr("content")},e.prototype.checkExistingVote=function(){console.log("Controller: Checking for existing votes  on user "+this.authorizer.userId),jQuery.ajax({url:this.baseURI+"/user",type:"GET",dataType:"jsonp",data:{article:this.getArticleId(),user:this.authorizer.userId}}).then(this.handleUserExistingVote.bind(this))},e.prototype.handleNotAuthorized=function(){console.log("Controller: User is not authorized to use app, but showing buttons"),this.model.setAllowedToVote(!0)},e.prototype.handleUserExistingVote=function(e){e.choice?(console.log("Controller: User has already voted for "+e.choice),this.model.registerVote(e.choice,!1)):(console.log("Controller: User has not voted yet"),this.model.setAllowedToVote(!0))},e.prototype.submitVote=function(e){this.authorizer.authUser().then(function(){jQuery.ajax({url:this.baseURI+"/vote",dataType:"jsonp",data:{article:this.getArticleId(),access_token:this.authorizer.accessToken,user:this.authorizer.userId,action:e}}).then(this.handlePostResponse.bind(this,e))}.bind(this))},e.prototype.handlePostResponse=function(e,t){t.error?console.error("Controller: Sorry - could not register your vote: "+t.error.message):(console.log("Controller: Posted response to Facebook OK. Voted for "+e),this.model.registerVote(e,!0))},e.prototype.destroy=function(){this.model.un(null,this)},e.APP_NAMESPACE="theguardian-spike",guardian.facebook.VoteController=e}(),function(){function e(e,t){this.jContainer=jQuery(e),this.authorizer=t,this.authorizer.authorize().then(this.showLoggedIn.bind(this)),this.authorizer.on("notLoggedIn",this.showLoginButton,this),this.authorizer.on("notAuthorized",this.showAuthorizeButton,this),this.authorizer.on("gotUserDetails",this.showLoggedIn,this),this.jContainer.delegate(".login","click.vote-component",this.handleLoginClick.bind(this))}e.prototype.showLoggedIn=function(e){e&&e.name?this.jContainer.find(".user-details").html("<span class='login'>Logged in as "+e.name+"</span>"):this.jContainer.find(".user-details").html("<span class='login'>Logged in</span>")},e.prototype.showLoginButton=function(){if(this.jContainer.find("a.login").length){this.handleLoginClick();return}this.jContainer.find(".user-details").html("<a class='login' href='http://www.facebook.com/'>Log in to Facebook</a>")},e.prototype.showAuthorizeButton=function(){console.log("Showing authorize button");if(this.jContainer.find(".login").length){this.handleLoginClick();return}this.jContainer.find(".user-details").html("<a class='login' href='http://www.facebook.com/'>Use the Guardian Facebook App</a>")},e.prototype.handleLoginClick=function(){return this.jContainer.find(".user-details").empty(),this.authorizer.authUser(),!1},guardian.facebook.LoginButtonView=e}();var Subscribable=function(){"use strict";function e(){}return e.prepareInstance=function(t){t.__events={},t.__handlers=[],t.on=e.on,t.un=e.un,t.fire=e.fire,t.hasListener=e.hasListener},e.prototype.__events=null,e.prototype.__handlers=null,e.prototype.on=function(){return e.prepareInstance(this),this.on.apply(this,arguments)},e.prototype.un=function(){return this},e.prototype.fire=function(){return!0},e.prototype.hasListener=function(e){return!1},e.fire=function(t){var n,r,i,s,o,u;typeof t=="object"&&(s=[t],t=t.constructor.toString()),u=e._getHandlersList(this,t,!1);if(u&&u.length){s=s||Array.prototype.slice.call(arguments,1);for(i,n=0,r=u.length;n<r&&i!==!1;n++)if(o=this.__handlers[u[n]])i=o[0].apply(o[1],s);return i!==!1}return!0},e._getHandlersList=function(e,t,n){return t=(""+t).toLowerCase(),!e.__events[t]&&n&&(e.__events[t]=[]),e.__events[t]},e._saveHandler=function(e,t,n,r){var i=e.__handlers.length;return e.__handlers.push([t,n,i]),r.push(i),i},e.on=function(t,n,r){return e._saveHandler(this,n,r,e._getHandlersList(this,t,!0))},e.un=function(t,n){var r=typeof t;switch(r){case"number":e.removeSingleEvent(this,t,n);break;case"string":case"function":t=(""+t).toLowerCase(),e.removeMultipleEvents(this,e._getHandlersList(this,t,!1),n),n&&e.consolidateEvents(this,t);break;default:t?(e.removeMultipleHandlers(this,this.__handlers,t||null),e.consolidateEvents(this)):(this.__handlers=[],this.__events={})}},e.consolidateEvents=function(t,n){if(!arguments.length)for(var n in t.__events)e.consolidateEvents(n);var r=t.__events[n];if(r&&r.length)for(var i=r.length-1;i>=0;i--)t.__handlers[r[i]]||r.splice(i,1);r&&!r.length&&delete t.__events[n]},e.removeMultipleEvents=function(t,n,r){for(var i=0,s=n.length;i<s;i++)e.removeSingleEvent(t,n[i],r)},e.removeMultipleHandlers=function(t,n,r){var i;for(var s=0,o=n.length;s<o;s++)(i=n[s])&&e.removeSingleEvent(t,i[2],r)},e.removeSingleEvent=function(e,t,n){e.__handlers[t]&&(!n||e.__handlers[t][1]===n)&&(e.__handlers[t]=null)},e.hasListener=function(e){var t,n,r,i;if(e===undefined){t=this.__handlers;for(r=0,i=t.length;r<i;r++)if(!!t[r])return!0}else if(n=this.__events[(""+e).toLowerCase()])for(var r=0,i=n.length;r<i;r++)if(this.__handlers[n[r]])return!0;return!1},e}();typeof module!="undefined"&&(module.exports=Subscribable),function(){function e(){this.choice=undefined,this.allowedToVote=!0,this.dataDeferred=jQuery.Deferred()}e.prototype=Object.create(Subscribable.prototype),e.prototype.questionId=null,e.prototype.options=null,e.prototype.choice=null,e.prototype.allowedToVote=null,e.prototype.setAllData=function(e){this.questionId=e.id,this.answers=e.answers,this.fire("dataChanged"),this.dataDeferred.resolve()},e.prototype.whenDataIsSet=function(){return this.dataDeferred.promise()},e.prototype.setAllowedToVote=function(e){this.allowedToVote=e,this.fire("dataChanged")},e.prototype.getAgree=function(){return this.answers&&this.answers[0].count},e.prototype.getDisagree=function(){return this.answers&&this.answers[1].count},e.prototype.getTotal=function(){return this.getAgree()+this.getDisagree()},e.prototype.getAnswerById=function(e){return this.answers.filter(function(t){return t.id==e})[0]},e.prototype.registerVote=function(e,t){this.whenDataIsSet().then(function(){var n=this.getAnswerById(e);n?(t===undefined||t===!0?(console.log("Model: Registering new vote: "+e),n.count++):console.log("Model: Noticing existing vote: "+e),this.choice=e,this.fire("dataChanged")):console.log("Unrecognised vote: "+e)}.bind(this))},e.prototype.getSummaryText=function(){return this.choice?"Your response was: "+this.getAnswerById(this.choice).label:"Your vote will be counted and shared on Facebook"},e.prototype.canVote=function(){return!this.choice&&this.allowedToVote},e.prototype.getAgreePercent=function(){var t=this.getTotal();return t?this.getAgree()/t*100:e.EVEN},e.prototype.destroy=function(){this.un()},e.EVEN=50,guardian.facebook.VoteModel=e}(),function(){function e(e,t,n){this.jContainer=jQuery(e).removeClass("initially-off"),this.model=t,this.initialise(n)}e.prototype=Object.create(Subscribable.prototype),e.prototype.jContainer=null,e.prototype.donut=null,e.prototype.model=null,e.prototype.initialise=function(t){this.jContainer.html(e.HTML),this.model.on("dataChanged",this.render,this),this.donut=new t(this.jContainer.find(".donut-container")),this.jContainer.delegate(".btn","click.vote-component",this.handleButtonClick.bind(this))},e.prototype.setVotingInProgress=function(){this.jContainer.find(".social-summary .text").html("Sending your vote to Facebook...")},e.prototype.render=function(){this.donut.render(this.model.getAgreePercent());var e=this.model.answers;this.jContainer.find(".choice").each(function(t,n){var r=e[t];jQuery(n).attr("data-action",r.id),jQuery(n).find(".count").html(r.count),jQuery(n).find(".label").html(r.label)}),this.jContainer.find(".choice").toggleClass("btn",this.model.canVote()),this.jContainer.find(".social-summary .text").html(this.model.getSummaryText())},e.prototype.handleButtonClick=function(e){var t=jQuery(e.currentTarget),n=t.data("action");this.jContainer.find(".btn").removeClass("btn"),this.fire("voted",n)},e.prototype.destroy=function(){this.model.un(null,this),this.jContainer.undelegate(".vote-component")},e.HTML='<div class="vote-component"><div class="vote-area"><span class="choice agree" data-action="agree"><span class="label"></span><span class="count"></span></span><div class="donut-container"></div><span class="choice disagree" data-action="disagree"><span class="count"></span><span class="label"></span></span></div><div class="social-summary"><span class="text"></span><div class="facebook-auth-status"><div class="user-details"></div></div></div></div>',guardian.facebook.VoteComponent=e}(),function(){function t(){this.authDeferred=jQuery.Deferred()}var e={scope:"email,publish_actions,publish_stream"};t.prototype=Object.create(Subscribable.prototype),t.accessToken=null,t.userId=null,t.prototype.getPromise=function(){return this.authDeferred.promise()},t.prototype.getAppId=function(){var e=window.identity&&identity.facebook&&identity.facebook.appId;return e||jQuery("meta[property='fb:app_id']").attr("content")},t.prototype.scriptLoaded=function(){FB.init({appId:this.getAppId(),channelUrl:"//"+document.location.host+":"+document.location.port+"/channel.html",status:!0,cookie:!0,xfbml:!0}),this.getLoginStatus()},t.prototype.authUser=function(){return this.accessToken||FB.login(this.handleGotLoginStatus.bind(this),e),this.getPromise()},t.prototype.getLoginStatus=function(){return FB.getLoginStatus(this.handleGotLoginStatus.bind(this),e),this.getPromise()},t.prototype.handleGotLoginStatus=function(e){console.log("Authorizer: Got Login Status: "+e.status);switch(e.status){case"connected":this.accessToken=e.authResponse.accessToken,this.userId=e.authResponse.userID,console.log("Authorizer: Access token: "+this.accessToken),this.fire("connected"),this.getUserData(),this.authDeferred.resolve();break;case"not_authorized":this.getUserData(),this.fire("notAuthorized");break;default:this.fire("notLoggedIn")}},t.prototype.getUserData=function(){console.log("Authorizer: Getting user data"),FB.api("/me",function(e){e.error||this.fire("gotUserDetails",e)}.bind(this))},t.prototype.authorize=function(){var e,t="facebook-jssdk",n=document.getElementsByTagName("script")[0];return document.getElementById(t)?this.getLoginStatus():(e=document.createElement("script"),e.id=t,e.async=!0,e.src="//connect.facebook.net/en_US/all.js",e.onload=this.scriptLoaded.bind(this),n.parentNode.insertBefore(e,n)),this.getPromise()},guardian.facebook.Authorizer=t}();