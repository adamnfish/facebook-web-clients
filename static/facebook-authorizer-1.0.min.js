ensurePackage("guardian.facebook"),function(e){"use strict";function t(){}function i(e,t){if(r)return t.indexOf(e);var n=t.length;while(n--)if(t[n]===e)return n;return-1}var n=t.prototype,r=Array.prototype.indexOf?!0:!1;n.getListeners=function(e){var t=this._events||(this._events={});return t[e]||(t[e]=[])},n.addListener=function(e,t){var n=this.getListeners(e);return i(t,n)===-1&&n.push(t),this},n.on=n.addListener,n.removeListener=function(e,t){var n=this.getListeners(e),r=i(t,n);return r!==-1&&(n.splice(r,1),n.length===0&&(this._events[e]=null)),this},n.off=n.removeListener,n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if(typeof t=="object")for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&(typeof i=="function"?s.call(this,r,i):o.call(this,r,i));else{r=n.length;while(r--)s.call(this,t,n[r])}return this},n.removeEvent=function(e){return e?this._events[e]=null:this._events=null,this},n.emitEvent=function(e,t){var n=this.getListeners(e),r=n.length,i;while(r--)i=t?n[r].apply(null,t):n[r](),i===!0&&this.removeListener(e,n[r]);return this},n.trigger=n.emitEvent,typeof define=="function"&&define.amd?define(function(){return t}):e.EventEmitter=t}(this),function(){function t(){this.authDeferred=jQuery.Deferred(),this.scriptLoadDeferred=jQuery.Deferred()}var e={scope:"email,publish_actions,publish_stream"};t.prototype=Object.create(EventEmitter.prototype),t.accessToken=null,t.userId=null,t.prototype.authUser=function(){return console.log("Authorizer: authUser"),this.accessToken||this._loadFacebookAPI().then(function(){FB.login(this.handleGotLoginStatus.bind(this),e)}.bind(this)),this.authDeferred.promise()},t.prototype.getLoginStatus=function(){return console.log("Authorizer: getLoginStatus"),this._loadFacebookAPI().then(function(){FB.getLoginStatus(this.handleGotLoginStatus.bind(this),e)}.bind(this)),this.authDeferred.promise()};var n="facebook-jssdk";t.prototype.handleGotLoginStatus=function(e){console.log("Authorizer: Got Login Status: "+e.status);switch(e.status){case"connected":this.accessToken=e.authResponse.accessToken,this.userId=e.authResponse.userID,console.log("Authorizer: Access token: "+this.accessToken),this.trigger(t.AUTHORIZED),this._getUserData(),this.authDeferred.resolve();break;case"not_authorized":this._getUserData(),this.trigger(t.NOT_AUTHORIZED);break;default:this.trigger(t.NOT_LOGGED_IN)}},t.prototype._getUserData=function(){console.log("Authorizer: Getting user data"),FB.api("/me",function(e){e&&!e.error&&this.trigger(t.GOT_USER_DETAILS,[e])}.bind(this))},t.prototype.getAppId=function(){console.log("Authorizer: Getting app id");var e=window.identity&&identity.facebook&&identity.facebook.appId;return e||jQuery("meta[property='fb:app_id']").attr("content")},t.prototype.scriptLoaded=function(){console.log("Authorizer: Handling script loaded"),FB.init({appId:this.getAppId(),channelUrl:"//"+document.location.host+":"+document.location.port+"/channel.html",status:!0,cookie:!0,xfbml:!0}),this.scriptLoadDeferred.resolve()},t.prototype._configureFacebookScript=function(){require(["http://connect.facebook.net/en_US/all.js"],this.scriptLoaded.bind(this))},t.prototype._loadFacebookAPI=function(){return console.log("Authorizer: Loading Facebook API"),window.FB?this.scriptLoadDeferred.resolve():!document.getElementById(n)&&!this.requiredAlready&&(this.requiredAlready=!0,this._configureFacebookScript()),this.scriptLoadDeferred.promise()},t.prototype.destroy=function(){this.removeEvent()},t.GOT_USER_DETAILS="gotUserDetails",t.NOT_LOGGED_IN="notLoggedIn",t.NOT_AUTHORIZED="notAuthorized",t.AUTHORIZED="connected",guardian.facebook.Authorizer=t}();