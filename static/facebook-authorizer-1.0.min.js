ensurePackage("guardian.facebook");var Subscribable=function(){"use strict";function e(){}return e.prepareInstance=function(t){t.__events={},t.__handlers=[],t.on=e.on,t.un=e.un,t.fire=e.fire,t.hasListener=e.hasListener},e.prototype.__events=null,e.prototype.__handlers=null,e.prototype.on=function(){return e.prepareInstance(this),this.on.apply(this,arguments)},e.prototype.un=function(){return this},e.prototype.fire=function(){return!0},e.prototype.hasListener=function(e){return!1},e.fire=function(t){var n,r,i,s,o,u;typeof t=="object"&&(s=[t],t=t.constructor.toString()),u=e._getHandlersList(this,t,!1);if(u&&u.length){s=s||Array.prototype.slice.call(arguments,1);for(i,n=0,r=u.length;n<r&&i!==!1;n++)if(o=this.__handlers[u[n]])i=o[0].apply(o[1],s);return i!==!1}return!0},e._getHandlersList=function(e,t,n){return t=(""+t).toLowerCase(),!e.__events[t]&&n&&(e.__events[t]=[]),e.__events[t]},e._saveHandler=function(e,t,n,r){var i=e.__handlers.length;return e.__handlers.push([t,n,i]),r.push(i),i},e.on=function(t,n,r){return e._saveHandler(this,n,r,e._getHandlersList(this,t,!0))},e.un=function(t,n){var r=typeof t;switch(r){case"number":e.removeSingleEvent(this,t,n);break;case"string":case"function":t=(""+t).toLowerCase(),e.removeMultipleEvents(this,e._getHandlersList(this,t,!1),n),n&&e.consolidateEvents(this,t);break;default:t?(e.removeMultipleHandlers(this,this.__handlers,t||null),e.consolidateEvents(this)):(this.__handlers=[],this.__events={})}},e.consolidateEvents=function(t,n){if(!arguments.length)for(var n in t.__events)e.consolidateEvents(n);var r=t.__events[n];if(r&&r.length)for(var i=r.length-1;i>=0;i--)t.__handlers[r[i]]||r.splice(i,1);r&&!r.length&&delete t.__events[n]},e.removeMultipleEvents=function(t,n,r){for(var i=0,s=n.length;i<s;i++)e.removeSingleEvent(t,n[i],r)},e.removeMultipleHandlers=function(t,n,r){var i;for(var s=0,o=n.length;s<o;s++)(i=n[s])&&e.removeSingleEvent(t,i[2],r)},e.removeSingleEvent=function(e,t,n){e.__handlers[t]&&(!n||e.__handlers[t][1]===n)&&(e.__handlers[t]=null)},e.hasListener=function(e){var t,n,r,i;if(e===undefined){t=this.__handlers;for(r=0,i=t.length;r<i;r++)if(!!t[r])return!0}else if(n=this.__events[(""+e).toLowerCase()])for(var r=0,i=n.length;r<i;r++)if(this.__handlers[n[r]])return!0;return!1},e}();typeof module!="undefined"&&(module.exports=Subscribable),function(){function t(){this.authDeferred=jQuery.Deferred(),this.scriptLoadDeferred=jQuery.Deferred()}var e={scope:"email,publish_actions,publish_stream"};t.prototype=Object.create(Subscribable.prototype),t.accessToken=null,t.userId=null,t.prototype.authUser=function(){return console.log("Authorizer: authUser"),this.accessToken||this._loadFacebookAPI().then(function(){FB.login(this.handleGotLoginStatus.bind(this),e)}.bind(this)),this.authDeferred.promise()},t.prototype.getLoginStatus=function(){return console.log("Authorizer: getLoginStatus"),this._loadFacebookAPI().then(function(){FB.getLoginStatus(this.handleGotLoginStatus.bind(this),e)}.bind(this)),this.authDeferred.promise()};var n="facebook-jssdk";t.prototype.handleGotLoginStatus=function(e){console.log("Authorizer: Got Login Status: "+e.status);switch(e.status){case"connected":this.accessToken=e.authResponse.accessToken,this.userId=e.authResponse.userID,console.log("Authorizer: Access token: "+this.accessToken),this.fire("connected"),this._getUserData(),this.authDeferred.resolve();break;case"not_authorized":this._getUserData(),this.fire("notAuthorized");break;default:this.fire("notLoggedIn")}},t.prototype._getUserData=function(){console.log("Authorizer: Getting user data"),FB.api("/me",function(e){e&&!e.error&&this.fire("gotUserDetails",e)}.bind(this))},t.prototype.getAppId=function(){console.log("Authorizer: Getting app id");var e=window.identity&&identity.facebook&&identity.facebook.appId;return e||jQuery("meta[property='fb:app_id']").attr("content")},t.prototype.scriptLoaded=function(){console.log("Authorizer: Handling script loaded"),FB.init({appId:this.getAppId(),channelUrl:"//"+document.location.host+":"+document.location.port+"/channel.html",status:!0,cookie:!0,xfbml:!0}),this.scriptLoadDeferred.resolve()},t.prototype._configureFacebookScript=function(){require(["http:////connect.facebook.net/en_US/all.js"],this.scriptLoaded.bind(this))},t.prototype._loadFacebookAPI=function(){return console.log("Authorizer: Loading Facebook API"),window.FB?this.scriptLoadDeferred.resolve():!document.getElementById(n)&&this.requiredAlready&&(this.requiredAlready=!0,this._configureFacebookScript()),this.scriptLoadDeferred.promise()},guardian.facebook.Authorizer=t}();