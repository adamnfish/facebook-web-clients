ensurePackage("guardian.facebook"),function(e){"use strict";function t(){}function i(e,t){if(r)return t.indexOf(e);var n=t.length;while(n--)if(t[n]===e)return n;return-1}var n=t.prototype,r=Array.prototype.indexOf?!0:!1;n.getListeners=function(e){var t=this._events||(this._events={});return t[e]||(t[e]=[])},n.addListener=function(e,t){var n=this.getListeners(e);return i(t,n)===-1&&n.push(t),this},n.on=n.addListener,n.removeListener=function(e,t){var n=this.getListeners(e),r=i(t,n);return r!==-1&&(n.splice(r,1),n.length===0&&(this._events[e]=null)),this},n.off=n.removeListener,n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if(typeof t=="object")for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&(typeof i=="function"?s.call(this,r,i):o.call(this,r,i));else{r=n.length;while(r--)s.call(this,t,n[r])}return this},n.removeEvent=function(e){return e?this._events[e]=null:this._events=null,this},n.emitEvent=function(e,t){var n=this.getListeners(e),r=n.length,i;while(r--)i=t?n[r].apply(null,t):n[r](),i===!0&&this.removeListener(e,n[r]);return this},n.trigger=n.emitEvent,e.EventEmitter=t}(this),function(){function e(){this.callbacks=[]}function n(){this._loggedIn=new e,this._facebookScriptLoaded=new e,this._userDataLoaded=new e}if(guardian.facebook.Authorizer)return;e.prototype.invalidate=function(){this.args=undefined},e.prototype.resolve=function(){this.args=Array.prototype.slice.apply(arguments),console.log(this.args);var e,t=this.callbacks.length;for(e=0;e<t;e++)this.callbacks[e].apply(null,this.args)},e.prototype.then=function(e){this.callbacks.push(e),this.args!==undefined&&e.apply(null,this.args)};var t={scope:"email,publish_actions,publish_stream"};n.prototype=Object.create(EventEmitter.prototype),n.accessToken=null,n.userId=null,n.userData=null,n.prototype.login=function(){return this.accessToken||this._loadFacebookAPI().then(function(e){e.login(this._handleGotLoginStatus.bind(this),t)}.bind(this)),this._loggedIn},n.prototype.getLoginStatus=function(){return this._loadFacebookAPI().then(function(e){e.getLoginStatus(this._handleGotLoginStatus.bind(this),t)}.bind(this)),this._loggedIn},n.prototype.whenGotUserData=function(){return this._userDataLoaded};var r="facebook-jssdk";n.prototype._handleGotLoginStatus=function(e){switch(e.status){case"connected":this.accessToken=e.authResponse.accessToken,this.userId=e.authResponse.userID,this.trigger(n.AUTHORIZED),this._getUserData(),this._loggedIn.resolve(FB);break;case"not_authorized":this._getUserData(),this.trigger(n.NOT_AUTHORIZED);break;default:this.trigger(n.NOT_LOGGED_IN)}},n.prototype._getUserData=function(){FB.api("/me",this._handleGotUserData.bind(this))},n.prototype._handleGotUserData=function(e){e&&!e.error&&(this.userData=e,this._userDataLoaded.resolve(this.userData),this.trigger(n.GOT_USER_DETAILS,[e]))},n.prototype._loadFacebookAPI=function(){return window.FB?this._facebookScriptLoaded.resolve(window.FB):!document.getElementById(r)&&!this._requiredAlready&&(this._requiredAlready=!0,this._loadFacebookScript()),this._facebookScriptLoaded},n.prototype._loadFacebookScript=function(){var e=require||curl;e(["//connect.facebook.net/en_US/all.js"],this._handleScriptLoaded.bind(this))},n.prototype._handleScriptLoaded=function(){FB.init({appId:this.getAppId(),channelUrl:"//"+document.location.host+":"+document.location.port+"/channel.html",status:!0,cookie:!0,xfbml:!0}),this._facebookScriptLoaded.resolve(FB)},n.prototype.getAppId=function(){var e=window.identity&&identity.facebook&&identity.facebook.appId,t=document.querySelector&&document.querySelector("meta[property='fb:app_id']");return e||t&&t.content},n.prototype.destroy=function(){this.removeEvent()},n.GOT_USER_DETAILS="gotUserDetails",n.NOT_LOGGED_IN="notLoggedIn",n.NOT_AUTHORIZED="notAuthorized",n.AUTHORIZED="connected",guardian.facebook.Authorizer=n}();