ensurePackage("guardian.facebook"),function(){function e(){this.callbacks=[]}function n(){i=this,this.onLoggedIn=new e,this.onFBScriptLoaded=new e,this.onUserDataLoaded=new e,this.onNotAuthorized=new e,this.onNotLoggedIn=new e}if(guardian.facebook.Authorizer)return;e.prototype.invalidate=function(){this.args=undefined},e.prototype.resolve=function(){this.args=Array.prototype.slice.apply(arguments);var e,t=this.callbacks.length;for(e=0;e<t;e++)this.callbacks[e].apply(null,this.args)},e.prototype.then=function(e){this.callbacks.push(e),this.args!==undefined&&e.apply(null,this.args)};var t={scope:"email,publish_actions,publish_stream"};n.prototype.onLoggedIn=null,n.prototype.onFBScriptLoaded=null,n.prototype.onUserDataLoaded=null,n.prototype.onNotAuthorized=null,n.prototype.onNotLoggedIn=null,n.accessToken=null,n.userId=null,n.userData=null,n.prototype.login=function(){return this.accessToken||this._loadFacebookAPI().then(function(e){e.login(this._handleGotLoginStatus.bind(this),t)}.bind(this)),this.onLoggedIn},n.prototype.getLoginStatus=function(){return this.loginStatusPending||(this.loginStatusPending=!0,this._loadFacebookAPI().then(function(e){e.getLoginStatus(this._handleGotLoginStatus.bind(this),t)}.bind(this))),this.onLoggedIn},n.prototype.getAppId=function(){var e=window.identity&&identity.facebook&&identity.facebook.appId,t=document.querySelector&&document.querySelector("meta[property='fb:app_id']");return e||t&&t.content};var r="facebook-jssdk";n.prototype._handleGotLoginStatus=function(e){this.loginStatusPending=!1;switch(e.status){case"connected":this.accessToken=e.authResponse.accessToken,this.userId=e.authResponse.userID,this._getUserData(),this.onLoggedIn.resolve(FB);break;case"not_authorized":this._getUserData(),this.onNotAuthorized.resolve(this);break;default:this.onNotLoggedIn.resolve()}},n.prototype._getUserData=function(){FB.api("/me",this._handleGotUserData.bind(this))},n.prototype._handleGotUserData=function(e){e&&!e.error&&(this.userData=e,this.onUserDataLoaded.resolve(e))},n.prototype._loadFacebookAPI=function(){return window.FB?this.onFBScriptLoaded.resolve(window.FB):!document.getElementById(r)&&!this._requiredAlready&&(this._requiredAlready=!0,this._loadFacebookScript()),this.onFBScriptLoaded},n.prototype._loadFacebookScript=function(){var e=require||curl;e(["//connect.facebook.net/en_US/all.js"],this._handleScriptLoaded.bind(this))},n.prototype._handleScriptLoaded=function(){FB.init({appId:this.getAppId(),channelUrl:"//"+document.location.host+":"+document.location.port+"/channel.html",status:!0,cookie:!0,xfbml:!0}),this.onFBScriptLoaded.resolve(FB)},n.prototype.destroy=function(){i=null};var i=null;guardian.facebook.Authorizer={getInstance:function(){return i||new n}}}();